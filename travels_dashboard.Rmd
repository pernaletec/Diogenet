---
title: "Diogenet's Map Dashboard"
subtitle: "Intellectual Networks from Ancient Greece"
output: 
  flexdashboard::flex_dashboard:
        favicon: iah_classicalstudies_logo_fv_pq.png
        navbar:
          - { icon: "fa-home", href: " http://diogenet.ucsd.edu", align: right }
runtime: shiny
---

```{r setup}
library(ggplot2)
library(tidyverse)
library(pleiades)
library(sf)
library(devtools)
library(georeference)
library(geosphere)
library(leaflet)
library(magrittr)
library(shiny)
library(DT)
library(sp)
library(htmlwidgets)
library(viridis)
library(igraph)
```

Travel's Map
===================================== 

Inputs {.sidebar}
-------------------------------------

```{r global, include=FALSE}

source("travels_data.R")

```

```{r}


h4("Traveler:")
# Node selection
selectInput(inputId = "philosopher", 
            label = NULL, 
            choices = c("All", travel_edges$name), 
            selected = "All")
br()
h4("Centrality Index:")
selectInput("centrality_type", NULL,
                c("Degree" = "degree",
                  "Betweenness" = "betweenness",
                  "Closeness" = "closeness",
                  "Eigenvector" = "eigenvector"))

#div(message, style = "color:red")


```

Row {.tabset}
-------------------------------------

### Map

```{r, echo = FALSE, message = FALSE}

travel_edges_reactive = reactive({
  # Filter by Phylosopher selected...if any
  if ((input$philosopher != "All") && !is.null(input$philosopher)) {
    travel_edges_selected = travel_edges$name %in% input$philosopher
    return(travel_edges[travel_edges_selected,])
  } else  return(travel_edges)
})

all_places_reactive = reactive({
  travel_edges = travel_edges_reactive()
  all_places = sort(unique(c(travel_edges$source,
                             travel_edges$target)), 
                    decreasing = FALSE)
  # These are the nodes in the graph
  return(data.frame(places = all_places))
})

all_places_full_data_reactive = reactive({
  
  all_places = all_places_reactive()
  drawn_places = all_places_full_data$name %in% all_places
  return(all_places_full_data[drawn_places,])
  
})

graph_reactive = reactive({
  
  ###############################################################################################
  ###################################                     #######################################  
  ##################################    GRAPH CREATION     ######################################
  ###################################                     #######################################
  ###############################################################################################
  
  travel_edges = travel_edges_reactive()
  all_places = all_places_reactive()
  
  try(graph <- igraph::graph_from_data_frame(d = travel_edges[,1:2], 
                                             directed=FALSE, 
                                             vertices = all_places$places), 
      silent = TRUE)
})

# network stores an object rendered by renderVisnetwork 
output$travels_network = renderLeaflet({
  
  tcu_map = "https://api.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaXNhd255dSIsImEiOiJBWEh1dUZZIn0.SiiexWxHHESIegSmW8wedQ"
  
  map_attr = "Map data &copy<a href='http://openstreetmap.org'>OpenStreetMap</a> contributors <a href='http://creativecommons.org/licenses/by-sa/2.0/'>CC-BY-SA</a> Imagery Â© <a href='http://mapbox.com'>Mapbox</a>"
  
  # This line is not requiered
  #m <- leaflet(avail_data_tb) %>% 
  m <- leaflet() %>% 
    addTiles(urlTemplate = tcu_map, attribution = map_attr, options = list(maxZoom = 10, 
                                                                           id = 'isawnyu.map-knmctlkh',
                                                                           accessToken =  'pk.eyJ1IjoiaXNhd255dSIsImEiOiJBWEh1dUZZIn0.SiiexWxHHESIegSmW8wedQ'))%>%
    setView(lng= 24.92, lat = 35.255, zoom = 5) 
  m
  
  # saveWidget(m, file = "map.html", selfcontained = TRUE)
})

# rescale the radius of the marker to the 5-20 scale
rescale_radius = function(x, min, max){
  y = ((20-5)/(max-min))*(x-min)+5
  return(y)
}

# x in this function is centrality vector
col_index = function(x, n_col, min, max) {((n_col -1)/(max - min))*(x-min)+1}

returnColor = function(char_col) {substr(char_col,1,nchar(char_col)-2)}

observe({
  
  travel_edges = travel_edges_reactive()
  all_places = all_places_reactive()
  graph = graph_reactive()

  ###############################################################################################
  ###################################                     #######################################
  ##################################     LEAFLET MAP       ######################################
  ###################################                     #######################################
  ###############################################################################################

  avail_data_tb = as_tibble(travel_edges)

  node_count = c(travel_edges$source, travel_edges$target)
  node_count = as.data.frame(table(node_count))

  all_places_full_data = all_places_full_data[(all_places_full_data$name %in% all_places$places),]
  all_places_full_data = all_places_full_data[order(all_places_full_data$name, decreasing = TRUE),]
  
  values = values()
  
  all_places_full_data$degree = values$degree
  all_places_full_data$betweenness = values$betweenness
  all_places_full_data$closeness = values$closeness
  all_places_full_data$eigenvector = values$eigenvector
  
  n_col =  50
  node_vir_col = viridis(n = n_col, begin = 0, end = 1, direction = 1, option = "plasma")
  
  if (!is.null(input$centrality_type)) {
  
    if (input$centrality_type == "degree") {
      centrality = all_places_full_data$degree

    }
    if (input$centrality_type == "betweenness") {
      centrality = all_places_full_data$betweenness      
    }
    if (input$centrality_type == "closeness") {
      centrality = all_places_full_data$closeness
    }
    if (input$centrality_type == "eigenvector") {
      centrality = all_places_full_data$eigenvector
    }
    
    all_places_full_data$centrality = centrality
    
    min = min(centrality)
    max = max(centrality)
    
    col_index_vector = col_index(centrality, n_col = n_col, min = min, max = max)
    
    pal  = colorNumeric(palette = "plasma", domain = centrality)
    
    text_title = input$centrality_type
  
    leafletProxy("travels_network") %>%
      clearShapes() %>%
      clearMarkers() %>%
      clearControls()
  
    for(i in 1:length(travel_edges$source)) {
      arc <- gcIntermediate( p1 = c(as.numeric(travel_edges$lon_source[i]), as.numeric(travel_edges$lat_source[i])),
                             p2 = c(as.numeric(travel_edges$lon_target[i]), as.numeric(travel_edges$lat_target[i])),
                             n=100, addStartEnd=TRUE )
        leafletProxy("travels_network") %>% addPolylines(
                          data=arc,
                          color="black",
                          weight=1,
                          stroke = TRUE,
                          smoothFactor = 5,
                          fillOpacity = 0.75, popup = paste0("<p><center><b>", travel_edges$name[i],
                                                             "</b><br/><small><i>From: </i>",
                                                              travel_edges$source[i],
                                                              "<br/><i>To: </i>",
                                                              travel_edges$target[i],
                                                              "<br/></small></center></p>")
                          )
    }

    str(viridis_pal(option = "plasma")(length(centrality)))
    
    leafletProxy("travels_network") %>% addCircleMarkers(data = all_places_full_data, 
                                                         all_places_full_data$lon,
                          all_places_full_data$lat,
                          popup=paste0("<p><center><b>", all_places_full_data$name,
                                       "</b><br/><small><i>Lat: </i>",
                                       all_places_full_data$lat,
                                       "<br/><i>Long: </i>",
                                       all_places_full_data$lon,
                                       "<br/></small></center></p>"),
                          radius=sapply(X = centrality, FUN = rescale_radius, min = min, max = max),
                          #color=node_vir_col[col_index_vector],
                          color = ~pal(centrality),
                          stroke =TRUE,
                          fillOpacity = 0.75)%>%
      addLegend(position = 'bottomright',pal = pal, values = centrality, title = text_title)
  
  }
})

# Use the visnetworkOutput function for visnetwork objects
leafletOutput(outputId="travels_network")

```

### Centralities

```{r, echo=FALSE}

values = reactive({
  
  graph = graph_reactive()
    
  val =  data.frame(degree = igraph::degree(graph),
                     betweenness = as.numeric(format(igraph::betweenness(graph, normalized =TRUE), 
                                                     digits = 3, nsmall = 3)),
                     closeness = as.numeric(format(igraph::closeness(graph), 
                                                   digits = 3, nsmall = 3)),
                     eigenvector = as.numeric(format(igraph::eigen_centrality(graph)$vector, 
                                                     digits = 3, nsmall = 3)))
  #val = val[order(val$degree, decreasing = TRUE),]
  return(val)

})

centr = reactive({
  
  graph = graph_reactive()
  
  centr_ = data.frame(degree = as.numeric(format(igraph::centralization.degree(graph)$centralization[1], 
                                                 digits = 3, nsmall = 3)),
                   betweenness = as.numeric(format(igraph::centralization.betweenness(graph)$centralization[1], 
                                                   digits = 3, nsmall = 3)),
                   closeness = as.numeric(format(igraph::centralization.closeness(graph)$centralization[1], 
                                                 digits = 3, nsmall = 3)),
                   eigenvector = as.numeric(format(igraph::centralization.evcent(graph)$centralization[1], 
                                                   digits = 3, nsmall = 3))
                   )
  row.names(centr_) = c("Graph")
  return(centr_)
})

output$table_values = DT::renderDataTable({datatable(values()[order(values()$degree, decreasing = TRUE),], selection = 'none', caption = 'Centrality scores', 
                                   options = list(
                                                 initComplete = JS(
                                                  "function(settings, json){",
                                                  "$(this.api().table().body()).css({'font-size': '14px'});",
                                                  "$(this.api().table().header()).css({'font-size': '12px'});",
                                                  "}"),
                                                  pageLength = 10,
                                                  lengthChange = FALSE,
                                                  processing = FALSE,
                                                  scrollX = TRUE
                                                  #,
                                                  #scrollY = TRUE,
                                                  #scrollCollapse = TRUE,
                                                  #autoWidth = TRUE
                                                  ,
                                                  columnDefs = list(list(width = '20%', targets = c(1, 2, 3, 4)),
                                                                    list(className = 'dt-center', targets = c(1, 2, 3, 4)))
                                                  ))})

output$table_centr = DT::renderDataTable({datatable(centr(), selection = 'none', caption = 'Centralization scores',
                                  options = list(lengthChange = FALSE,
                                                 processing = FALSE,
                                                 ordering = FALSE,
                                                 #autoWidth = TRUE,
                                                 scrollX = TRUE,
                                                 searching = FALSE,
                                                 paging = FALSE,
                                                 info = FALSE
                                                 ,
                                                 columnDefs = list(list(width = '20%', targets = c(1, 2, 3, 4)),
                                                                   list(className = 'dt-center', targets = c(1, 2, 3, 4)))
                                                 ,
                                                 initComplete = JS(
                                                    "function(settings, json){",
                                                    "$(this.api().table().body()).css({'font-size': '14px'});",
                                                    "$(this.api().table().header()).css({'font-size': '12px'});",
                                                    "$(this.api().table().header()).css({'background-color': '#326ed6', 'color': '#fff'});",
                                                    "}")
                                                 ))})
                                                 
fillCol(DT::DTOutput(outputId = 'table_centr'),
        br(),
        DT::DTOutput(outputId = 'table_values'), flex = c(NA,NA,NA))

```

